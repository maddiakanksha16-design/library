<?php
// edit_book.php
require 'db.php';
$id = intval($_GET['id'] ?? 0);
if (!$id) { header('Location: books.php'); exit; }

$msg = '';
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $isbn = trim($_POST['isbn']);
    $title = trim($_POST['title']);
    $author = trim($_POST['author']);
    $publisher = trim($_POST['publisher']);
    $year = intval($_POST['year']) ?: null;
    $copies = intval($_POST['copies']) ?: 1;

    // update available: simple strategy: adjust available by difference
    $stmt = $mysqli->prepare("SELECT copies, available FROM books WHERE id = ?");
    $stmt->bind_param("i", $id);
    $stmt->execute();
    $res = $stmt->get_result()->fetch_assoc();
    $stmt->close();
    $oldCopies = $res['copies'];
    $oldAvailable = $res['available'];
    $available = $oldAvailable + ($copies - $oldCopies);
    if ($available < 0) $available = 0;

    $stmt = $mysqli->prepare("UPDATE books SET isbn=?, title=?, author=?, publisher=?, year=?, copies=?, available=? WHERE id=?");
    $stmt->bind_param("sssssiii", $isbn, $title, $author, $publisher, $year, $copies, $available, $id);
    if ($stmt->execute()) $msg = "Book updated.";
    else $msg = "Error: " . $stmt->error;
    $stmt->close();
}

$stmt = $mysqli->prepare("SELECT * FROM books WHERE id = ?");
$stmt->bind_param("i",$id);
$stmt->execute();
$book = $stmt->get_result()->fetch_assoc();
$stmt->close();
if (!$book) { header('Location: books.php'); exit; }
?>
<!doctype html>
<html>
<head><meta charset="utf-8"><title>Edit Book</title></head>
<body>
  <a href="books.php">? Back</a>
  <h2>Edit Book</h2>
  <?php if($msg) echo "<p style='color:green;'>$msg</p>"; ?>
  <form method="post">
    <label>ISBN<br><input name="isbn" value="<?php echo htmlspecialchars($book['isbn']) ?>"></label><br><br>
    <label>Title<br><input name="title" required value="<?php echo htmlspecialchars($book['title']) ?>"></label><br><br>
    <label>Author<br><input name="author" value="<?php echo htmlspecialchars($book['author']) ?>"></label><br><br>
    <label>Publisher<br><input name="publisher" value="<?php echo htmlspecialchars($book['publisher']) ?>"></label><br><br>
    <label>Year<br><input name="year" type="number" min="1900" max="2100" value="<?php echo $book['year'] ?>"></label><br><br>
    <label>Copies<br><input name="copies" type="number" min="1" value="<?php echo $book['copies'] ?>"></label><br><br>
    <button type="submit">Save</button>
  </form>
</body>
</html>
